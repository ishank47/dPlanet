#!/bin/sh
set -e

if [[ "$APP_DEBUG" = 'true' ]]
then
  if ! apk list | grep php7-pear >/dev/null 2>&1;
  then
    apk add --update \
        coreutils \
        php7-phar \
        php7-pecl-xdebug \
        php7-xmlwriter
  else
    echo "Skipping APK installation, already done"
  fi
  mkdir -p /home/php/.composer
  chown -R php:php /home/php
  cp /app/src/bin/composer /bin/composer
  su -s /bin/sh -c "composer install -d /app/src" php

  cat <<-EOF > /usr/local/etc/php/conf.d/xdebug.ini
xdebug.remote_enable=1
xdebug.remote_autostart=1
xdebug.profiler_enable=1
xdebug.remote_connect_back=on
xdebug.default_enable=1
xdebug.remote_port=9000
xdebug.idekey=PHPSTORM
display_errors = On
EOF

fi

# Ensure named volumes are owned by php
chown -Rc php:php /app/src/public/bundles
chown -Rc php:php /app/src/public/uploads
chown -Rc php:php /ssl

. /bin/expand-secrets.sh && \
  su -s /bin/sh -c \
    "bin/console cache:clear --env=${APP_ENV} --no-debug \
    && bin/console assets:install \
    && bin/console --no-interaction doctrine:cache:clear-metadata \
    && bin/console --no-interaction doctrine:cache:clear-query \
    && bin/console --no-interaction doctrine:cache:clear-result \
    && bin/console doctrine:database:create --no-interaction --if-not-exists \
    && bin/console doctrine:migrations:migrate --no-interaction --no-debug \
    && bin/console cache:warmup --env=${APP_ENV} --no-debug" \
  php

php-fpm
