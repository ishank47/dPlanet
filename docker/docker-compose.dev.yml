version: '3.3'

volumes:
  development_ssl: ~

networks:
  mysql: ~

services:
  php-fpm:
    build:
      context: ../
      dockerfile: docker/php-fpm/Dockerfile
    volumes:
      - ../src:/app/src:cached
      - ./php-fpm/bin/docker-entrypoint:/bin/docker-entrypoint:cached
    networks:
      - mysql
    environment:
      DATABASE_HOSTNAME: mysql
      DATABASE_PASSWORD: development
      APP_ENV: dev
      APP_DEBUG: "true"
      APP_SECRET: thisisasampletokenthatiputhereonlyfordevelopmentproductionhasasecretsecretofcourse

  ssl:
    build:
      context: ssl-dev
    volumes:
      - development_ssl:/ssl

  webpack:
    image: yarnpkg/node-yarn:node7
    user: node
    volumes:
      - ../src:/app:cached
    ports:
      - 8080:8080
    working_dir: /app
    command: ["/bin/sh", "-c", "yarn install && npm rebuild node-sass && yarn watch"]

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    networks:
      - mysql
      - nginx
    environment:
      PMA_HOST: mysql
    ports:
      - 8000:80

  nginx:
    build:
      context: ../
      dockerfile: docker/nginx/Dockerfile
    environment:
      server_name: localhost
      hsts_max_time: 0m
      fastcgi_cache_valid: 1s
      cache_max_age: 1
    volumes:
      - development_ssl:/etc/letsencrypt/live/localhost
      - ../src/public/assets:/var/www/html/assets:cached
      - ./nginx/etc/nginx/temp:/etc/nginx/temp:cached

  mysql:
    image: mysql:5.7
    networks:
      - mysql
    volumes:
      - db-data:/var/lib/mysql
    restart: always
    expose:
      - 3306
    environment:
      MYSQL_DATABASE: dplanet
      MYSQL_USER: dplanet
      MYSQL_RANDOM_ROOT_PASSWORD: 'true'
      MYSQL_PASSWORD: development
    ports:
      - 3306:3306
